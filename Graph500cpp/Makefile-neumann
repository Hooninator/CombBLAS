INCDIR = $(HOME)
INCADD = -I$(INCDIR)

# notes for configure:
# -fno-exceptions does not work with MPICH2
# -fno-rtti does not work with tr1:tuples

OPT = -DNDEBUG -O3 -DMPICH_IGNORE_CXX_SEEK
DEB = -g -O0 -fno-inline -DMPICH_IGNORE_CXX_SEEK #-DDEBUG
COMPILER = mpicxx
FLAGS = $(DEB)  -DGRAPH_GENERATOR_SEQ -Drestrict

GENERATOR_OBJS_SEQ=btrd_binomial_distribution.o splittable_mrg.o mrg_transitions.o graph_generator.o permutation_gen.o scramble_edges.o utils.o

GENERATOR_SRCS_SEQ=btrd_binomial_distribution.c splittable_mrg.c mrg_transitions.c graph_generator.c permutation_gen.c scramble_edges.c utils.c

all: graph500


%.o : %.c %.h
	$(COMPILER) $(INCADD) $(FLAGS) -c $< -o $@

#
# build Graph500 generator
#

# todo: make this build into the currect directory
libgenerator.a: $(addprefix ../CombBLAS/graph500-1.2/generator/,$(GENERATOR_OBJS_SEQ))
	#$(COMPILER) $(INCADD) $(FLAGS) -c $(addprefix ../CombBLAS/graph500-1.2/generator/,$(GENERATOR_SRCS_SEQ))
	ar rcs libgenerator.a $(addprefix ../CombBLAS/graph500-1.2/generator/,$(GENERATOR_OBJS_SEQ))

#
#build CombBLAS
#

CommGrid.o:	../CombBLAS/CommGrid.cpp ../CombBLAS/CommGrid.h
	$(COMPILER) $(INCADD) $(FLAGS) -c -o CommGrid.o ../CombBLAS/CommGrid.cpp

MPIType.o:	../CombBLAS/MPIType.cpp ../CombBLAS/MPIType.h
	$(COMPILER) $(INCADD) $(FLAGS) -c -o MPIType.o ../CombBLAS/MPIType.cpp

MemoryPool.o:	../CombBLAS/MemoryPool.cpp ../CombBLAS/SpDefs.h
	$(COMPILER) $(INCADD) $(FLAGS) -c -o MemoryPool.o ../CombBLAS/MemoryPool.cpp


#build graph500 binary

graph500.o: graph500.cpp ../CombBLAS/SpDCCols.cpp ../CombBLAS/dcsc.cpp ../CombBLAS/SpHelper.h ../CombBLAS/SpParMat.h ../CombBLAS/ParFriends.h ../CombBLAS/SpParMat.cpp ../CombBLAS/SpDefs.h ../CombBLAS/SpTuples.cpp ../CombBLAS/DistEdgeList.h ../CombBLAS/DistEdgeList.cpp
	$(COMPILER) $(INCADD) $(FLAGS) -c -o graph500.o graph500.cpp

graph500:	MemoryPool.o CommGrid.o MPIType.o graph500.o libgenerator.a
	$(COMPILER) $(INCADD) $(FLAGS) -o graph500 graph500.o MemoryPool.o CommGrid.o MPIType.o -L. -lgenerator



clean:
	rm -f graph500 
	rm -f *.o
	rm -f *.a

cleanout:
	rm out.*
	rm err.*
